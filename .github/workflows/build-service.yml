name: Build Specific Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Сервис для сборки'
        required: true
        type: choice
        options:
          - balance-service
          - smtp-service
          - unie
          - unie-admin
          - nginx
      environment:
        description: 'Окружение для сборки'
        required: true
        type: choice
        options:
          - development
          - production
        default: 'development'
      push_image:
        description: 'Отправить образ в Docker Hub'
        required: true
        type: boolean
        default: false

jobs:
  build-service:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        if: ${{ github.event.inputs.push_image == 'true' }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set build target
        id: set-target
        run: |
          if [ "${{ github.event.inputs.service }}" == "balance-service" ]; then
            if [ "${{ github.event.inputs.environment }}" == "development" ]; then
              echo "BUILD_TARGET=development" >> $GITHUB_ENV
            else
              echo "BUILD_TARGET=production" >> $GITHUB_ENV
            fi
          else
            # Для других сервисов, если есть специфические target'ы
            echo "BUILD_TARGET=" >> $GITHUB_ENV
          fi
          
      - name: Set environment variables from secrets
        id: set-env
        run: |
          # Экспортируем переменные окружения из GitHub Secrets для использования в контейнере
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
          echo "SHADOW_DATABASE_URL=${{ secrets.SHADOW_DATABASE_URL }}" >> $GITHUB_ENV
          echo "NODE_ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ github.event.inputs.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}" >> $GITHUB_ENV
          echo "STRIPE_SECRET_KEY=${{ github.event.inputs.STRIPE_SECRET_KEY }}" >> $GITHUB_ENV
          
          # Создаем build args для Docker билда
          echo "BUILD_ARGS=DATABASE_URL=${{ secrets.DATABASE_URL }} SHADOW_DATABASE_URL=${{ secrets.SHADOW_DATABASE_URL }} NODE_ENV=${{ github.event.inputs.NODE_ENV }} NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ github.event.inputs.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }} STRIPE_SECRET_KEY=${{ github.event.inputs.STRIPE_SECRET_KEY }}" >> $GITHUB_ENV
          
          echo "Environment variables configured successfully"
          echo "Available env vars: DATABASE_URL, SHADOW_DATABASE_URL, NODE_ENV"
          echo "Build args set for Docker build"

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./services/${{ github.event.inputs.service }}
          push: ${{ github.event.inputs.push_image == 'true' }}
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/unie-${{ github.event.inputs.service }}:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/unie-${{ github.event.inputs.service }}:${{ github.sha }}
          build-args: |
            NODE_ENV=${{ github.event.inputs.environment }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            SHADOW_DATABASE_URL=${{ secrets.SHADOW_DATABASE_URL }}
          target: ${{ env.BUILD_TARGET }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/unie-${{ github.event.inputs.service }}:buildcache
          cache-to: ${{ github.event.inputs.push_image == 'true' && format('type=registry,ref={0}/unie-{1}:buildcache,mode=max', secrets.DOCKER_HUB_USERNAME, github.event.inputs.service) || '' }}

      - name: Show build result
        run: |
          echo "Сервис ${{ github.event.inputs.service }} успешно собран для окружения ${{ github.event.inputs.environment }}"
          if [ "${{ github.event.inputs.push_image }}" == "true" ]; then
            echo "Образ отправлен в Docker Hub: ${{ secrets.DOCKER_HUB_USERNAME }}/unie-${{ github.event.inputs.service }}:latest"
          else
            echo "Образ не был отправлен в Docker Hub"
          fi
